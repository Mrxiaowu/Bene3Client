#pragma once
#include "uart/ProtocolSender.h"
#include <string>
#include <cstdlib>
#include <iostream>
using namespace std;

#define STB_IMAGE_WRITE_IMPLEMENTATION		// 要在导入头文件前，定义该宏
#include "activity/imageWrite.h"



static S_ACTIVITY_TIMEER REGISTER_ACTIVITY_TIMER_TAB[] = {
	//{0,  6000}, //定时器id=0, 时间间隔6秒
	//{1,  1000},
};

/**
 * 当界面构造时触发
 */
static SProtocolData mProtocolData;
static void onUI_init(){
	LOGD("printjob onUI_init !!!\n"); //06FF011F01DA
	sendSampleProtocol(0x06, 0xFF, 0x01, 0x1F, 0x01);
}

/**
 * 当切换到该界面时触发
 */
static void onUI_intent(const Intent *intentPtr) {
    if (intentPtr != NULL) {
        //TODO
    }
}

/*
 * 当界面显示时触发
 */
static void onUI_show() {

}


static void onUI_hide() { //当界面隐藏时触发

}


static void onUI_quit() {//当界面完全退出时触发

}


//static void MySaveJPG(string hexString1) {
static void MySaveJPG(BYTE *hexArray ,int hexArrayLength) {

	const int dw = 200, dh = 112;
	const int n = 3;	// rgb

	int totalsize = dw * dh;
	uint8_t *buffer = (uint8_t *) malloc(totalsize * n); // 存储转化后的图像数据
	memset(buffer, 0xFF, totalsize * n);	// 对数组清零

//	原始字符串
//	hexString1 = "0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000380004001FC00060000600000000000000000000000000000078000EE07FC001E0000F00000000000000000000000000000078000EF0FFC10170000F000000000000000000000000000000F8000E78C0830370800F000000000000000000000000000000F8010E1C80830330801D00000000000000000000000000000098010E1E00870338801900000000000000000000000000000098030E0E00070738C03900000000000000000000000000000018070E0E000E0718C03800000000000000000000000000000038070E07000E071CE030000000000000000000000000000000380E0E07000E0E1CE070000000000000000000000000000000381C0E07000E0E0E6070000000000000000000000000000000381C0E07000E0C0E70E000000000000000000000000000000038380E07000E1C0E70E000000000000000000000000000000038700E07000E1C07F0FF00000000000000000000000000000038700E07000E1807F8FF01000000000000000000000000000038E00E0E00073803F8FF01000000000000000000000000000038C00E0E0007B8031C8001000000000000000000000000000038C00F1C8003B0031C8003000000000000000000000000000038800F7CC003F0011C8003000000000000000000000000000038800FF8FF01F0010E0007000000000000000000000000000038000FE07F00E0010E00070000000000000000000000000000180006801F00C0000600060000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000FEFFF83FE01FFF7F0000000000000000000000000000000000FEFFF83FF81FFF7F0000000000000000000000000000000000FE7FF81F7C1CFF7F0000000000000000000000000000000000800338001C00C0010000000000000000000000000000000000800338000E00C0010000000000000000000000000000000000800338000E00C0010000000000000000000000000000000000800338000E00C0010000000000000000000000000000000000800338001C00C0010000000000000000000000000000000000800338003C00C00100000000000000000000000000000000008003F81FF800C00100000000000000000000000000000000008003F81FF003C00100000000000000000000000000000000008003F81FC00FC001000000000000000000000000000000000080033800001FC001000000000000000000000000000000000080033800001CC0010000000000000000000000000000000000800338000038C0010000000000000000000000000000000000800338000038C0010000000000000000000000000000000000800338000038C0010000000000000000000000000000000000800338000038C0010000000000000000000000000000000000800338000E1CC00100000000000000000000000000000000008003F83FFE1FC00100000000000000000000000000000000008003F83FFC07C001000000000000000000000000000000000000000000C00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";
	//转化后的字符串
//	string convertHexString = convertHsxStringToNormal(hexString1);

	std::vector<uint8_t> hexArray2;
	for(int i=0;i < hexArrayLength; i++){
		for(int j=0; j < 8 ;j++){
			bool ret = (hexArray[i] >> (7-j)) & 0x01;
			if(ret)
				hexArray2.push_back(0xFF);
			 else
				hexArray2.push_back(0x00);
		}
	}

	for(int i = 0; i < totalsize; i++) {
		buffer[i*3] = buffer[i*3+1] = buffer[i*3+2] = hexArray2[i];
	}

	//TODO,这里编译时需要换目录？
	int ret = stbi_write_jpg("/mnt/extsd/printImage.jpg", dw, dh, n, buffer, 100);
	LOGD("ret %d\n", ret);
	free(buffer);
}


static void onProtocolDataUpdate(const SProtocolData &data) { //串口数据回调接口

	if(data.page != 9 || data.page != 8){
		LOGD("当前读取的串口信息中的PageID不为9或者是8");
		return;
	} else {
		LOGD("进入打印任务页面");
	}

	LOGD("当前读取的串口信息 %x %x %x , %x",data.region ,data.type , data.label ,data.cancellParam);

	if(data.region == 0xFF && data.type == 0xFF && data.label == 0xFF){
		LOGD("弹出弹出框");
		mprintJobDialogPtr->setVisible(true);
	}

	if(data.region == 16){
		if(data.type == 1){
			if(data.label == 45){
				myzhouTextPtr->setText(data.pdata);
			} else if(data.label == 46){
				mlayerTextPtr->setText(data.pdata);
			} else if(data.label == 47){
				mlayerspeedTextPtr->setText(data.pdata);
			} else if(data.label == 48){
				mprintstatusTextPtr->setText(data.pdata);
			}
		} else if(data.type == 4 && data.label == 22){
			mfilenameTextPtr->setText(data.pdata);
		}
	} else if(data.region == 17){
		if(data.type == 4 && data.label == 23){
			mprinttimeTextPtr->setText(data.pdata);
		} else if(data.type == 12 && data.label == 0){
			mCirclebar1Ptr->setProgress(16);
		} else if(data.type == 1 && data.label == 0x2A && data.cancellParam == 0x2B){ //AA55 09 04 09 11 01 2A 09 11 01 2B 71
			LOGD("更换为继续 ");
			mresumePtr->setVisible(true);
			mcancellPtr->setVisible(false);
		} else if(data.type == 1 && data.label == 0x2B && data.cancellParam == 0x2A){//AA55 09 04 09 11 01 2B 09 11 01 2A 71
			LOGD("更换为暂停");
			mresumePtr->setVisible(false);
			mcancellPtr->setVisible(true);
		}
	}



	//这里避免其他命令也会进入这里
	if(data.region == 16 && data.type == 10 && data.label == 2){
		LOGD("这是在传输图片");
		MySaveJPG(data.imageData,data.imageLength);
		mprintImagePtr->setBackgroundPic("/mnt/extsd/printImage.jpg");
	}
}


static bool onUI_Timer(int id){
	switch (id) {

		default:
			break;
	}
    return true;
}


static bool onprintJobActivityTouchEvent(const MotionEvent &ev) {

	return false;
}

//返回按钮
static bool onButtonClick_sys_back(ZKButton *pButton) {
	EASYUICONTEXT->openActivity("mainActivity");
	LOGD(" ButtonClick sys_back !!!\n");
	return true;
}

//取消按钮
static bool onButtonClick_cancell(ZKButton *pButton) {//AA 55 05 09 FF 01 2A 01 CC
    LOGD(" ButtonClick cancell !!!\n");//09FF012A01CC
	sendSampleProtocol(0x09, 0xFF, 0x01, 0x2A, 0x01);//
    return false;
}

//停止按钮
static bool onButtonClick_stop(ZKButton *pButton) {//AA 55 05 09 FF 01 2C 01 CA
    LOGD(" ButtonClick stop !!!\n");
    sendSampleProtocol(0x09, 0xFF, 0x01, 0x2C, 0x01);
    return false;
}
static bool onButtonClick_line(ZKButton *pButton) {
    //LOGD(" ButtonClick line !!!\n");
    return false;
}
static bool onButtonClick_resume(ZKButton *pButton) {//09FF012B01CB
    LOGD(" onButtonClick_resume!!!\n");
	sendSampleProtocol(0x09, 0xFF, 0x01, 0x2B, 0x01);//
    return false;
}
static bool onButtonClick_PrintJobconfirm(ZKButton *pButton) {
    LOGD(" ButtonClick PrintJobconfirm !!!\n");
	BYTE mode[] = { 0x08, 0xFF, 0x01, 0x28, 0x01 };
	sendProtocol( mode , 5);
	mprintJobDialogPtr->setVisible(false);
    return false;
}

static bool onButtonClick_PrintJobcancell(ZKButton *pButton) {
    LOGD(" ButtonClick PrintJobcancell !!!\n");
	BYTE mode[] = { 0x08, 0xFF, 0x01, 0x29, 0x01 };
	sendProtocol( mode , 5);
	mprintJobDialogPtr->setVisible(false);
    return false;
}
